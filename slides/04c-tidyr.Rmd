---
title: "Transform a data frame"
company: "`r if(exists('info')) info$company`"
author: "`r if(exists('info')) info$author`"
date: "`r if(exists('info')) info$date`"
output:
  ioslides_presentation: 
    css: styles.css
    logo: img/ZEIF.png
    widescreen: yes
---
  
```{r setup, include=FALSE}
library(knitr)
library(tidyverse)
opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE, collapse = TRUE, comment = "")

stop_video <- function() {
  #out <- '<div class="red2">**Please stop the video here! Continue after completing the task!**</div>'
  out <- '<div class="red2">**:-)**</div>'
  cat(out)
}

```

## `pivot_longer()`

- `cols`: The columns to be aggregated into a new variable.  
- `names_to`: The name of the new variable containing the names of the aggregated columns.  
- `values_to`: The name of the variable containing the values of the aggregated columns.

##

<div class="left">

**Wide format:**

```{r echo=FALSE}
df <- data.frame(player=c('A', 'B', 'C', 'D'),
                 year1=c(12, 15, 19, 19),
                 year2=c(22, 29, 18, 12))

df
```

</div>

<div class="right">

**Long format:**

```{r}
pivot_longer(
  df, 
  cols = 2:3, 
  names_to = 'year', 
  values_to = 'points'
)
```

</div>

## Task {.smaller}

Take the `billboard` dataset. It looks like this:
  
```{r echo = FALSE}
billboard %>% rmarkdown::paged_table()
```

## {.smaller}

Use the `pivot_longer()` function to create a dataset that looks like this:
  
```{r echo = FALSE}
billboard %>%
  pivot_longer(starts_with("wk"), names_to = "week", values_to = "position", values_drop_na = TRUE) %>% 
  rmarkdown::paged_table()
```

##

```{r}
billboard %>%
  pivot_longer(starts_with("wk"), names_to = "week", 
               values_to = "position", values_drop_na = TRUE)
```


## Complex example {.smaller}

We have such a dataframe:

```{r echo = FALSE}
kable(relig_income) %>% kableExtra::kable_classic_2()
```

## We want such a plot: {.smaller}

```{r echo = FALSE}
relig_income %>% 
  rowwise() %>%
  mutate(total = sum(c_across(2:11))) %>%
  ungroup() %>%
  filter(total >= 500) %>%
  mutate(across(2:11, ~ . / total * 100)) %>%
  pivot_longer(2:11, names_to = "income", values_to = "count") %>%
  mutate(income = factor(income, levels = names(relig_income)[2:11])) %>%
  ggplot(aes(x = income, y = count)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_wrap(~religion) + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle = 45, size = 7, hjust = 1)) +
  ylab("%")
```


## Step 1: Turn the count values into percentages: {.smaller}

<div class = "left">

```{r}
# with dplyr:
new_df <- relig_income %>% 
  rowwise() %>%
  mutate(total = sum(c_across(2:11))) %>%
  ungroup() %>%
  mutate(across(2:11, ~ . / total * 100)) %>%
  filter(total >= 500)
```

</div>

<div class = "right">

```{r}
# with base R
new_df <- as.data.frame(relig_income)
new_df$total <- apply(new_df[, 2:11], 1, sum)
new_df <- new_df[new_df$total >= 500,]

for(i in 1:nrow(new_df))  
  new_df[i, 2:11] <- new_df[i, 2:11] / new_df$total[i] * 100
```

</div>

<p></p>

```{r echo = FALSE}
new_df
```



## Step 2: Turn data into long format: {.smaller}


```{r}
# tidy R
new_long <- new_df %>%
  pivot_longer(col = 2:11, names_to = "income", values_to = "count")


#  base R:
new_long <- data.frame(
  religion = rep(NA, nrow(new_df) * 10), 
  income = rep(names(new_df)[2:11], nrow(new_df)), 
  count = rep(NA, nrow(new_df) * 10))

new_long$religion <- rep(new_df$religion, each = 10)

for(i in 1:nrow(new_df))
  new_long$count[((i-1)*10+1):((i-1)*10+10)] <- as.numeric(new_df[i, 2:11])

```

```{r echo = FALSE}
kable(new_long) %>% kableExtra::kable_classic_2()
```

## Create the plot {.smaller}

```{r echo = FALSE}
new_long %>%
  mutate(income = factor(income, levels = names(relig_income)[2:11])) %>%
  ggplot(aes(x = income, y = count)) +
  geom_bar(stat = "identity", position = "dodge") +
  facet_wrap(~religion) + 
  theme_classic() + 
  theme(axis.text.x = element_text(angle = 45, size = 7, hjust = 1)) +
  ylab("%")
```




