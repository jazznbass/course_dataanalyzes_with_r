<!DOCTYPE html>
<html lang="" xml:lang="">
  <head>
    <title>Regression</title>
    <meta charset="utf-8" />
    <script src="libs/header-attrs-2.11/header-attrs.js"></script>
    <link href="libs/remark-css-0.0.1/default.css" rel="stylesheet" />
    <link href="libs/remark-css-0.0.1/default-fonts.css" rel="stylesheet" />
    <link rel="stylesheet" href="styles_xa.css" type="text/css" />
  </head>
  <body>
    <textarea id="source">
class: center, middle, title-slide

# Regression
## Estimating models and predicting values with R
### 

---




background-image: url("DEFOCUSED.png")

# Prerequisite

- You have basic knowledge on statistical regression

# Goal

- You know how to fit regression models in R

---

# Regression

- In a statistical regression you explain a variable (criteria or dependent variable) by one or more other variables (predictors or independent variables).

--

- You *regress* the criteria variable on the predictor variables.

--

- E.g.: You want to explain the *life expecancy* by certain aspects of behavior (diet, physical activity), enviornmental aspects (polution, health care).

--

- Therefore, you try to set up a mathematical function which tries to estimate what *life expectancy* a person has given all the other variables.


---

# Regression formula

.pull-left[

`\(y_i = \beta_0 + \beta_1X_i + e_i\)`  

`\(y\)` = Criteria variable  
`\(i\)` = Subject number (measurement number)  
`\(\beta_0\)` = Intercept of `\(y\)`  
`\(\beta_1\)` = Weight of predictor `\(X\)`  
`\(X\)` = Predictor variable  
`\(e\)` = Error term
]

.pull-right[

![](07-Regression_XA_files/figure-html/unnamed-chunk-1-1.png)&lt;!-- --&gt;

]

---

# `lm()` function

- The `lm()` function fits a regression model.

- `lm(formula, data)`

- ***Formulas*** are a basic data type that is applied in many R functions.

- Basic structur:  ***dependent variable ~ explanatory variables***  
(e.g. ***y ~ x1 + x2***)

- `data` takes a dataframe

`lm(dist ~ speed, data = cars)`

---

# Example


![](07-Regression_XA_files/figure-html/unnamed-chunk-2-1.png)&lt;!-- --&gt;

---

# Example


![](07-Regression_XA_files/figure-html/unnamed-chunk-3-1.png)&lt;!-- --&gt;

---

# Example

.pull-left[

![](07-Regression_XA_files/figure-html/unnamed-chunk-4-1.png)&lt;!-- --&gt;

]

.pull-right[


```r
fit &lt;- lm(dist ~ speed, data = cars)
fit
```

```

Call:
lm(formula = dist ~ speed, data = cars)

Coefficients:
(Intercept)        speed  
    -17.579        3.932  
```

`\(dist_i = -17.579 + 3.932 * speed_i\)`

]

---


```r
summary(fit)
```

```

Call:
lm(formula = dist ~ speed, data = cars)

Residuals:
    Min      1Q  Median      3Q     Max 
-29.069  -9.525  -2.272   9.215  43.201 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) -17.5791     6.7584  -2.601   0.0123 *  
speed         3.9324     0.4155   9.464 1.49e-12 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 15.38 on 48 degrees of freedom
Multiple R-squared:  0.6511,	Adjusted R-squared:  0.6438 
F-statistic: 89.57 on 1 and 48 DF,  p-value: 1.49e-12
```

.

Modelfit:  
`\(F(1, 48) = 89.57; p &lt; .001 ; RÂ² = .65\)`

---

# Task

- Take the `mtcars` dataset.

- Calculate the correlation of mileage `mpg` and car weight `wt`.

- Plot a scatterplot with ggplot (mileage on the x-axis and weight on the y-axis).

- Add a regression line with (`geom_smooth(method = "lm")`).

- Regress mileage `mpg` on car weight `wt` (that is, predict mileage by means of weight).

---

.pull-left[


```r
cor(mtcars$mpg, mtcars$wt)
```

```
[1] -0.8676594
```

```r
fit &lt;- lm(mpg ~ wt, data = mtcars)
summary(fit)
```

```

Call:
lm(formula = mpg ~ wt, data = mtcars)

Residuals:
    Min      1Q  Median      3Q     Max 
-4.5432 -2.3647 -0.1252  1.4096  6.8727 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)  37.2851     1.8776  19.858  &lt; 2e-16 ***
wt           -5.3445     0.5591  -9.559 1.29e-10 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 3.046 on 30 degrees of freedom
Multiple R-squared:  0.7528,	Adjusted R-squared:  0.7446 
F-statistic: 91.38 on 1 and 30 DF,  p-value: 1.294e-10
```
]

--

.pull-right[

```r
ggplot(mtcars, aes(x = mpg, y = wt)) + 
  geom_point() + 
  geom_smooth(method = "lm")
```

![](07-Regression_XA_files/figure-html/unnamed-chunk-8-1.png)&lt;!-- --&gt;
]
 
---

# Task

- Take the `temp_carbon` dataset from the `dslabs` library.

- Make yourself familiar with the dataset: `?temp_carbon`.

- Plot a scatterplot with ggplot (year on the x-axis and temp_anomaly on the y-axis).

- Add a regression line with (`geom_smooth(method = "lm")`).

- Regress `temp_anomaly` on `year` (that is, predict temp_anomaly by means of year).

---

.pull-left[


```r
library(dslabs)
fit &lt;- lm(temp_anomaly ~ year, 
          data = temp_carbon)
summary(fit)
```

```

Call:
lm(formula = temp_anomaly ~ year, data = temp_carbon)

Residuals:
     Min       1Q   Median       3Q      Max 
-0.32598 -0.11846 -0.01062  0.11185  0.43367 

Coefficients:
              Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept) -1.409e+01  6.750e-01  -20.87   &lt;2e-16 ***
year         7.259e-03  3.463e-04   20.96   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 0.1638 on 137 degrees of freedom
  (129 observations deleted due to missingness)
Multiple R-squared:  0.7623,	Adjusted R-squared:  0.7606 
F-statistic: 439.4 on 1 and 137 DF,  p-value: &lt; 2.2e-16
```
]

--

.pull-right[

```r
ggplot(temp_carbon, aes(x = year, 
                        y = temp_anomaly)) + 
  geom_point() + 
  geom_smooth(method = "lm")
```

![](07-Regression_XA_files/figure-html/unnamed-chunk-10-1.png)&lt;!-- --&gt;
] 
 
 
---

# Multiple predictors

- A `formula` can take multiple predictors:  
`y ~ x1 + x2`

- An Interaction describes a relation between two (or more) predictors where the influence of one predictor changes with the value of the other predictor (e.g. weight and smoking  influence blood pressure. And the influence of smoking is even higher for those who are overweight).

- An interaction is modeled with a `:` sign:  
y ~ x1 + x2 + x1:x2

---

### Example Predict mileage `'mpg'` by weight `'wt'` and number of cylinders `'cyl'` and its interaction


```r
fit &lt;- lm(mpg ~ wt + cyl + wt:cyl, data = mtcars)
summary(fit)
```

```

Call:
lm(formula = mpg ~ wt + cyl + wt:cyl, data = mtcars)

Residuals:
    Min      1Q  Median      3Q     Max 
-4.2288 -1.3495 -0.5042  1.4647  5.2344 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)  54.3068     6.1275   8.863 1.29e-09 ***
wt           -8.6556     2.3201  -3.731 0.000861 ***
cyl          -3.8032     1.0050  -3.784 0.000747 ***
wt:cyl        0.8084     0.3273   2.470 0.019882 *  
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 2.368 on 28 degrees of freedom
Multiple R-squared:  0.8606,	Adjusted R-squared:  0.8457 
F-statistic: 57.62 on 3 and 28 DF,  p-value: 4.231e-12
```

---

# Task

- Take the `gapminder` dataset from the `dslabs` library.

- Predict infant mortality (`infant_mortality`) by year (`year`) and average number of children per woman (`fertility`).

- Take the interaction into account.

- How to interpret the estimates?

---


```r
library(dslabs)
fit &lt;- lm(infant_mortality ~ year + fertility + fertility:year, data = gapminder)
summary(fit)
```

```

Call:
lm(formula = infant_mortality ~ year + fertility + fertility:year, 
    data = gapminder)

Residuals:
    Min      1Q  Median      3Q     Max 
-81.327 -11.540  -1.282  11.575 141.101 

Coefficients:
                 Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)    -5.902e+02  8.588e+01  -6.873 6.72e-12 ***
year            2.872e-01  4.308e-02   6.666 2.77e-11 ***
fertility       3.574e+02  1.869e+01  19.130  &lt; 2e-16 ***
year:fertility -1.708e-01  9.404e-03 -18.168  &lt; 2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 25.84 on 9088 degrees of freedom
  (1453 observations deleted due to missingness)
Multiple R-squared:  0.7071,	Adjusted R-squared:  0.707 
F-statistic:  7312 on 3 and 9088 DF,  p-value: &lt; 2.2e-16
```

---

- Although the previous computation is correct (!). The estimates is misleading. The intercept, for example, depicts the average dependent variable when all predictors are zero (i.e. year is 0 and fertility is 0).

- We can mend this by centering the predictor variables. 

- Centering is achieved by subtracting the mean of a variable from each measurement of that variable. That is, the value 0 now depicts the average.


```r
dat &lt;- gapminder
dat$year &lt;- dat$year - mean(dat$year, na.rm = TRUE)
# alternatively, use the scale function to center a variable:
dat$fertility &lt;- scale(dat$fertility, scale = FALSE)
fit &lt;- lm(infant_mortality ~ year + fertility + fertility:year, data = dat)
summary(fit)
```

---


```r
dat &lt;- gapminder
dat$year &lt;- scale(dat$year, scale = FALSE)
dat$fertility &lt;- scale(dat$fertility, scale = FALSE)
fit &lt;- lm(infant_mortality ~ year + fertility + fertility:year, data = dat)
summary(fit)
```

```

Call:
lm(formula = infant_mortality ~ year + fertility + fertility:year, 
    data = dat)

Residuals:
    Min      1Q  Median      3Q     Max 
-81.327 -11.540  -1.282  11.575 141.101 

Coefficients:
                Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)    53.452151   0.304781  175.38   &lt;2e-16 ***
year           -0.410454   0.019561  -20.98   &lt;2e-16 ***
fertility      17.796992   0.150837  117.99   &lt;2e-16 ***
year:fertility -0.170849   0.009404  -18.17   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 25.84 on 9088 degrees of freedom
  (1453 observations deleted due to missingness)
Multiple R-squared:  0.7071,	Adjusted R-squared:  0.707 
F-statistic:  7312 on 3 and 9088 DF,  p-value: &lt; 2.2e-16
```

---

# Categorical predictors (comparing groups)

- Predictors can be categorical variables.

- Examples of categorical variables are: students with vs. without special educational needs; gender; Haircolor.

- They have to be `factors` to recognize them as `categorical`.

---

# Example

- We predict `mpg` by `wt` and the transmission type `am` and their interaction.

- The transmission type is a categorical variable. By default `am` is not a factor. So we have to turn `am` into a factor first.

---


```r
mtcars$wt_centered &lt;- scale(mtcars$wt, scale = FALSE)
mtcars$am_factor &lt;- factor(mtcars$am, labels = c("Automatic", "Manual"))
fit &lt;- lm(mpg ~ wt_centered + am_factor + wt_centered:am_factor, data = mtcars)
summary(fit)
```

```

Call:
lm(formula = mpg ~ wt_centered + am_factor + wt_centered:am_factor, 
    data = mtcars)

Residuals:
    Min      1Q  Median      3Q     Max 
-3.6004 -1.5446 -0.5325  0.9012  6.0909 

Coefficients:
                            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)                  19.2358     0.7357  26.147  &lt; 2e-16 ***
wt_centered                  -3.7859     0.7856  -4.819 4.55e-05 ***
am_factorManual              -2.1677     1.4189  -1.528  0.13779    
wt_centered:am_factorManual  -5.2984     1.4447  -3.667  0.00102 ** 
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 2.591 on 28 degrees of freedom
Multiple R-squared:  0.833,	Adjusted R-squared:  0.8151 
F-statistic: 46.57 on 3 and 28 DF,  p-value: 5.209e-11
```

---

# Task


```r
heights$sex &lt;- factor(heights$sex)
fit &lt;- lm(height ~ sex, data = heights)
summary(fit)
```

```

Call:
lm(formula = height ~ sex, data = heights)

Residuals:
     Min       1Q   Median       3Q      Max 
-19.3148  -2.3148  -0.3148   2.6852  14.0606 

Coefficients:
            Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)  64.9394     0.2363  274.82   &lt;2e-16 ***
sexMale       4.3753     0.2687   16.28   &lt;2e-16 ***
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 3.645 on 1048 degrees of freedom
Multiple R-squared:  0.2019,	Adjusted R-squared:  0.2012 
F-statistic: 265.1 on 1 and 1048 DF,  p-value: &lt; 2.2e-16
```

---

# Contrasts

- In the previous example, we compared the effect of an automatic against a manual gearshift. This is called a **contrast**. In this case, our intercept represented the *mpg* for the automatic gearshift and the predictor represented the change in the *mpg* values for manual gearshifts. 

- This type of contrast is called a "treatment" contrast. 

- An alternative approach would be to calculate the average of 'mpg' across both types of gearshifts and the predictor represents how much the type of gearshift influences 'mpg'.

- This type of contrast is called a Helmert contrast.

***Example***

Fitting `lm(mpg ~ am_factor, data = mtcars)` with a treatment contrast:


```
    (Intercept) am_factorManual 
      17.147368        7.244939 
```

Fitting `lm(mpg ~ am_factor, data = mtcars)` with a Helmert contrast:


```
(Intercept)  am_factor1 
   20.76984     3.62247 
```

---

    
- The `constrasts()` function gets and sets contrasts for factors

- Treatment contrasts for two factor levels:  
    `contrasts(mtcars$am_factor) &lt;- contr.treatment(2)`
    
- Helmert contrasts for two factor levels:  
    `contrasts(mtcars$am_factor) &lt;- contr.helmert(2)`

---

# Task
    
- Take the `mtcars` dataset

- Predict `mpg` by `wt` and the transmission type `am` and their interaction

- By deafult `am` is not a factor. Please create a factor for `am` first

- Set the contrasts of the factor to *Helmert* and calculate the model.

- Set the contrasts of the factor to *Treatment* and calculate the model

- Compare the results of the two models and discuss them with you seatmate

---


```r
mtcars$am_factor &lt;- factor(mtcars$am, labels = c("Automatic", "Manual"))
contrasts(mtcars$am_factor) &lt;- contr.helmert(2)
fit1 &lt;- lm(mpg ~ wt + am_factor + wt:am_factor, data = mtcars)
summary(fit1)
```

```

Call:
lm(formula = mpg ~ wt + am_factor + wt:am_factor, data = mtcars)

Residuals:
    Min      1Q  Median      3Q     Max 
-3.6004 -1.5446 -0.5325  0.9012  6.0909 

Coefficients:
              Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)    38.8553     2.1320  18.225  &lt; 2e-16 ***
wt             -6.4351     0.7223  -8.909 1.16e-09 ***
am_factor1      7.4392     2.1320   3.489  0.00162 ** 
wt:am_factor1  -2.6492     0.7223  -3.667  0.00102 ** 
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 2.591 on 28 degrees of freedom
Multiple R-squared:  0.833,	Adjusted R-squared:  0.8151 
F-statistic: 46.57 on 3 and 28 DF,  p-value: 5.209e-11
```

```r
contrasts(mtcars$am_factor) &lt;- contr.treatment(2)
fit2 &lt;- lm(mpg ~ wt + am_factor + wt:am_factor, data = mtcars)
summary(fit2)
```

```

Call:
lm(formula = mpg ~ wt + am_factor + wt:am_factor, data = mtcars)

Residuals:
    Min      1Q  Median      3Q     Max 
-3.6004 -1.5446 -0.5325  0.9012  6.0909 

Coefficients:
              Estimate Std. Error t value Pr(&gt;|t|)    
(Intercept)    31.4161     3.0201  10.402 4.00e-11 ***
wt             -3.7859     0.7856  -4.819 4.55e-05 ***
am_factor2     14.8784     4.2640   3.489  0.00162 ** 
wt:am_factor2  -5.2984     1.4447  -3.667  0.00102 ** 
---
Signif. codes:  0 '***' 0.001 '**' 0.01 '*' 0.05 '.' 0.1 ' ' 1

Residual standard error: 2.591 on 28 degrees of freedom
Multiple R-squared:  0.833,	Adjusted R-squared:  0.8151 
F-statistic: 46.57 on 3 and 28 DF,  p-value: 5.209e-11
```

---
class: center, middle
# Multilevel regressions
***
---

# Multilevel regression formula

`\(y_{ij} = \beta_{0j} + \beta_{1j} X_{ij} + e_{ij}\)`

Level 2:  
`\(\beta_{0j} = \gamma_{01}W_j + \upsilon_{0j}\)`  
`\(\beta_{1j} = \gamma_{10} + \upsilon_{1j}\)`  

`\(y\)` = Criteria variable  
`\(i\)` = Subject number (measurement number)  
`\(\beta_0\)` = Intercept of `\(y\)`  
`\(\beta_1\)` = Weight of predictor `\(X\)`  
`\(X\)` = Predictor variable  
`\(e\)` = Error term  
`\(j\)` = Level 2 group number  
`\(\gamma_{00}\)` = Intercept  
`\(W\)` = Level 2 predictor (grouping variable)  
`\(\gamma_{01}\)` = Weight for `\(W\)`  
`\(\upsilon_{0j}\)` = Error term for intercept
`\(\gamma_{10}\)` = Weight of the predictor     
`\(\upsilon_{0j}\)` = Error term for slope  

    </textarea>
<style data-target="print-only">@media screen {.remark-slide-container{display:block;}.remark-slide-scaler{box-shadow:none;}}</style>
<script src="https://remarkjs.com/downloads/remark-latest.min.js"></script>
<script>var slideshow = remark.create({
"highlightStyle": "github",
"highlightLines": true,
"countIncrementalSlides": false,
"ratio": "16:10"
});
if (window.HTMLWidgets) slideshow.on('afterShowSlide', function (slide) {
  window.dispatchEvent(new Event('resize'));
});
(function(d) {
  var s = d.createElement("style"), r = d.querySelector(".remark-slide-scaler");
  if (!r) return;
  s.type = "text/css"; s.innerHTML = "@page {size: " + r.style.width + " " + r.style.height +"; }";
  d.head.appendChild(s);
})(document);

(function(d) {
  var el = d.getElementsByClassName("remark-slides-area");
  if (!el) return;
  var slide, slides = slideshow.getSlides(), els = el[0].children;
  for (var i = 1; i < slides.length; i++) {
    slide = slides[i];
    if (slide.properties.continued === "true" || slide.properties.count === "false") {
      els[i - 1].className += ' has-continuation';
    }
  }
  var s = d.createElement("style");
  s.type = "text/css"; s.innerHTML = "@media print { .has-continuation { display: none; } }";
  d.head.appendChild(s);
})(document);
// delete the temporary CSS (for displaying all slides initially) when the user
// starts to view slides
(function() {
  var deleted = false;
  slideshow.on('beforeShowSlide', function(slide) {
    if (deleted) return;
    var sheets = document.styleSheets, node;
    for (var i = 0; i < sheets.length; i++) {
      node = sheets[i].ownerNode;
      if (node.dataset["target"] !== "print-only") continue;
      node.parentNode.removeChild(node);
    }
    deleted = true;
  });
})();
(function() {
  "use strict"
  // Replace <script> tags in slides area to make them executable
  var scripts = document.querySelectorAll(
    '.remark-slides-area .remark-slide-container script'
  );
  if (!scripts.length) return;
  for (var i = 0; i < scripts.length; i++) {
    var s = document.createElement('script');
    var code = document.createTextNode(scripts[i].textContent);
    s.appendChild(code);
    var scriptAttrs = scripts[i].attributes;
    for (var j = 0; j < scriptAttrs.length; j++) {
      s.setAttribute(scriptAttrs[j].name, scriptAttrs[j].value);
    }
    scripts[i].parentElement.replaceChild(s, scripts[i]);
  }
})();
(function() {
  var links = document.getElementsByTagName('a');
  for (var i = 0; i < links.length; i++) {
    if (/^(https?:)?\/\//.test(links[i].getAttribute('href'))) {
      links[i].target = '_blank';
    }
  }
})();
// adds .remark-code-has-line-highlighted class to <pre> parent elements
// of code chunks containing highlighted lines with class .remark-code-line-highlighted
(function(d) {
  const hlines = d.querySelectorAll('.remark-code-line-highlighted');
  const preParents = [];
  const findPreParent = function(line, p = 0) {
    if (p > 1) return null; // traverse up no further than grandparent
    const el = line.parentElement;
    return el.tagName === "PRE" ? el : findPreParent(el, ++p);
  };

  for (let line of hlines) {
    let pre = findPreParent(line);
    if (pre && !preParents.includes(pre)) preParents.push(pre);
  }
  preParents.forEach(p => p.classList.add("remark-code-has-line-highlighted"));
})(document);</script>

<script>
slideshow._releaseMath = function(el) {
  var i, text, code, codes = el.getElementsByTagName('code');
  for (i = 0; i < codes.length;) {
    code = codes[i];
    if (code.parentNode.tagName !== 'PRE' && code.childElementCount === 0) {
      text = code.textContent;
      if (/^\\\((.|\s)+\\\)$/.test(text) || /^\\\[(.|\s)+\\\]$/.test(text) ||
          /^\$\$(.|\s)+\$\$$/.test(text) ||
          /^\\begin\{([^}]+)\}(.|\s)+\\end\{[^}]+\}$/.test(text)) {
        code.outerHTML = code.innerHTML;  // remove <code></code>
        continue;
      }
    }
    i++;
  }
};
slideshow._releaseMath(document);
</script>
<!-- dynamically load mathjax for compatibility with self-contained -->
<script>
(function () {
  var script = document.createElement('script');
  script.type = 'text/javascript';
  script.src  = 'https://mathjax.rstudio.com/latest/MathJax.js?config=TeX-MML-AM_CHTML';
  if (location.protocol !== 'file:' && /^https?:/.test(script.src))
    script.src  = script.src.replace(/^https?:/, '');
  document.getElementsByTagName('head')[0].appendChild(script);
})();
</script>
  </body>
</html>
