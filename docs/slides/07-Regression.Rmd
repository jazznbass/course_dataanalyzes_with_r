---
title: "Regression"
subtitle: 'Estimating models and predicting values with R'
company: "`r if(exists('info')) info$company`"
author: "`r if(exists('info')) info$author`"
date: "`r if(exists('info')) info$date`"
---

```{r setup, include=FALSE}
library(knitr)
library(tidyverse)
opts_chunk$set(echo = TRUE, warning = FALSE, message = FALSE)
```

## Goals {.emphasized data-background=img/DEFOCUSED.png data-background-size=cover .flexbox .vcenter}

- An introduction to regression analyses
- An introduction to fitting regression models in R




## Regression {.columns-2 .smaller}

$y_i = \beta_0 + \beta_1X_i + e_i$


$y$ = Criteria variable  
$i$ = Subject number (measurement number)  
$\beta_0$ = Intercept of $y$  
$\beta_1$ = Weight of predictor $X$  
$X$ = Predictor variable  
$e$ = Error term  

<p class="forceBreak"></p>

```{r echo = FALSE, fig.height=5, fig.width=5}
plot(c(0,1), c(1,5), type = "l", xlab = "Predictor X", ylab = "Criteria Y", ylim = c(0,5))
text(x = 0.6, y = 4, "Slope ß1")

```



## `lm()` function

- The `lm()` function fits a regression model.
- `lm(formula, data)`
- ***Formulas*** are a basic data type that is applied in many R functions.
- Basic structur:  ***dependent variable ~ explanatory variables***  (e.g. ***y ~ x1 + x2***)
- `data` takes a dataframe

`lm(dist ~ speed, data = cars)`

## Example

```{r echo = FALSE}
ggplot(cars, aes(x = speed, y = dist)) +
  geom_point() +
  geom_smooth(method = "lm") +
  ggtitle("Breaking distances at various speeds") + 
  geom_text(x = 10, y = 100, label = paste0("Correlation r = ", round(cor(cars$speed, cars$dist), 2)))
```

## 

```{r}
fit <- lm(dist ~ speed, data = cars)
fit
```

$dist_i = -17.579 + 3.932 * speed_i$

## Summary {.smaller}

```{r}
summary(fit)
```

Modelfit:  
$F(1, 48) = 89.57; p < .001 ; R² = .65$

## Task

- Take the `mtcars` dataset
- Calculate the correlation of mileage `mpg` and car weight `wt`
- Plot a scatterplot with mileage on x and weight on y
- Add a regression line with (`geom_smooth(method = "lm")`)
- Regress mileage `mpg` on car weight `wt` (that is, predic mileage by means of weight)



## Task {.columns-2 .smaller}

```{r fig.width=4, fig.height=4}
cor(mtcars$mpg, mtcars$wt)
ggplot(mtcars, aes(x = mpg, y = wt)) + 
  geom_point() + 
  geom_smooth(method = "lm")
fit <- lm(mpg ~ wt, data = mtcars)
summary(fit)

```

## Multiple predictors

- A `formula` can take multiple predictors: `y ~ x1 + x2`
- An Interaction describes a relationi between two (or more) predictors where influce of one predictor changes with the value of the other predictor (e.g. weight and smoking  influence blood preassure. And the influence of smoking is even highe for those who are overweight)
- An interaction is modelled with a `:` sign: y ~ x1 + x2 + x1:x2

## Task

- Take the `mtcars` dataset
- Predict mileage `mpg` by weight `wt` and number of cylinders `cyl`
- Take the interaction into account
- Discuss with your seatmate how to interpret the estimates


## {.smaller}

```{r}
fit <- lm(mpg ~ wt + cyl + wt:cyl, data = mtcars)
summary(fit)
```

## Categorical data

- Predictors can be categorical variables
- They have to be `factors`for `formulas` to recognice them as `categorical`
- Remember: you can create a factor with the `factor()` function

## Task

- Take the `mtcars` dataset
- Predict `mpg` by `wt` and the transmission type `am` and their interaction
- By deafult `am` is not a factor. Please create a factor for `am` first
- Discuss with you seatmate how to interpret the estimates

##

```{r}
mtcars$am_factor <- factor(mtcars$am, labels = c("Automatic", "Manual"))
fit <- lm(mpg ~ wt + am_factor + wt:am_factor, data = mtcars)
summary(fit)
```

## Changing the contrast


- Contrasts describe how to compare the influnce of two (or more) factor levels.
- Two common ways are:
    - Treatment: One factor level is the baseline
    - Helmert: The average of the two factor levels are the baseline
- The `constrasts()` function gets and sets contrasts for factors
- Treatment contrasts for two factor levels:  
    `contrasts(mtcars$am_factor) <- contr.treatment(2)`
- Helmert contrasts for two factor levels:  
    `contrasts(mtcars$am_factor) <- contr.helmert(2)`

## Task {.smaller}
    
- Take the `mtcars` dataset
- Predict `mpg` by `wt` and the transmission type `am` and their interaction
- By deafult `am` is not a factor. Please create a factor for `am` first
- Set the contrasts of the factor to *Helmert* and calculate the model.
- Set the contrasts of the factor to *Treatment* and calculate the model
- Compare the results of the two models and discuss them with you seatmate

## 

```{r}
mtcars$am_factor <- factor(mtcars$am, labels = c("Automatic", "Manual"))
contrasts(mtcars$am_factor) <- contr.helmert(2)
fit1 <- lm(mpg ~ wt + am_factor + wt:am_factor, data = mtcars)
summary(fit1)
contrasts(mtcars$am_factor) <- contr.treatment(2)
fit2 <- lm(mpg ~ wt + am_factor + wt:am_factor, data = mtcars)
summary(fit2)

```


## Multilevel regression formula {.smaller}

$y_{ij} = \beta_{0j} + \beta_{1j} X_{ij} + e_{ij}$

Level 2:  
$\beta_{0j} = \gamma_{01}W_j + \upsilon_{0j}$  
$\beta_{1j} = \gamma_{10} + \upsilon_{1j}$  

$y$ = Criteria variable  
$i$ = Subject number (measurement number)  
$\beta_0$ = Intercept of $y$  
$\beta_1$ = Weight of predictor $X$  
$X$ = Predictor variable  
$e$ = Error term  
$j$ = Level 2 group number  
$\gamma_{00}$ = Intercept  
$W$ = Level 2 predictor (grouping variable)  
$\gamma_{01}$ = Weight for $W$  
$\upsilon_{0j}$ = Error term for intercept
$\gamma_{10}$ = Weight of the predictor     
$\upsilon_{0j}$ = Error term for slope  

